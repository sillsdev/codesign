name: Sign digest
on:
  workflow_dispatch:
    inputs:
      token:
        required: true
        type: string
      provider:
        default: "LsDevSectigoEV"
        type: string
      job:
        description: The job generated by generate-digest
        required: true
        type: string
      calling-repo:
        description: The repository where the generate-digest workflow ran
        required: true
        type: string
  workflow_call:
    inputs:
      provider:
        default: "LsDevSectigoEV"
        type: string
      job:
        description: The job generated by generate-digest
        required: true
        type: string
    outputs:
      signed-job: 
        value: ${{ jobs.sign-digest.outputs.job }}
env:
  algorithm: ${{ fromJSON(inputs.job).algorithm }}
  artifact: codesign-digests-${{ fromJSON(inputs.job).id }}
  path: job-${{ fromJSON(inputs.job).id }}
jobs:
  sign-digest:
    outputs:
      job: ${{ inputs.job }}
    runs-on: [self-hosted, ltops-signing]
    steps:
    - name: Mask token
      run: echo "::add-mask::${{ inputs.token }}"
    - name: Download Artifact (Workflow Call)
      uses: actions/download-artifact@v4
      if: ${{ github.event_name == 'workflow_call' }}
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}

    - name: Download Artifact (Workflow Dispatch)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        curl -L "https://api.github.com/repos/${{ inputs.calling-repo }}/actions/artifacts/${{ env.artifact }}" \
        -o "artifact.zip" \
        -H "Authorization: Bearer ${{ inputs.token }}" \
        -H "Accept: application/vnd.github.v3+json"
        echo "Artifacts downloaded"
        ls -lh artifact.zip
        file artifact.zip
        cat artifact.zip
#        unzip "artifact.zip" -d ${{ env.path }}
 
    - id: sign
      working-directory: ${{ env.path }}
      run: |
        readarray -t digests <<<"$(ls *.dig)"
        for dig in "${digests[@]}"
        do
          digest=$(cat "$dig")
          sign-digest ${{inputs.provider}} ${{ env.algorithm }} "$digest" > "$dig.signed"
        done  
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
        if-no-files-found: error
        overwrite: true

    - id: clean-up
      run: rm -rf ${{ env.path }}