name: Sign digest
on:
  workflow_call:
    inputs:
      provider:
        default: "LsDevSectigoEV"
        type: string
      job:
        description: The job generated by generate-digest
        required: true
        type: string
env:
  algorithm: ${{ fromJSON(inputs.job).algorithm }}
  artifact: codesign-job-${{ fromJSON(inputs.job).id }}
  path: job-${{ fromJSON(inputs.job).id }}
jobs:
  sign-digest:
    runs-on: [self-hosted, ltops-signing]
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
  
    - id: sign
      working-directory: ${{ env.path }}
      run: |
        for dig in $(ls *.dig)
        do
          sign-digest ${{inputs.provider}} ${{ env.algorithm }} "$(cat $dig)" > $dig.signed
        done  
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
        if-no-files-found: error
        overwrite: true

    - id: clean-up
      run: rm -rf ${{ env.path }}