name: Sign digest
on:
  workflow_call:
    inputs:
      provider:
        default: "LsDevSectigoEV"
        type: string
      job:
        description: The job generated by generate-digest
        required: true
        type: string
    outputs:
      signed-job:
        description: "Signature for the supplied digest"
        value: ${{ jobs.sign-digest.outputs.job }}
jobs:
  sign-digest:
    runs-on: [self-hosted, ltops-signing]
    outputs:
      job: ${{ inputs.job }}
    env:
      artifact: codesign-job-${{ inputs.job }}
      path: job-${{ inputs.job }}
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
  
    - id: sign
      run: |
        cd ${{ env.path }}
        algorithm=$(cat .algorithm)
        for dig in $(ls *.dig)
        do
          echo with $algorithm, for digest: $dig = $(cat $dig)
          echo sign-digest ${{inputs.provider}} $algorithm "$(cat $dig)" > $dig.signed
        done  
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
        if-no-files-found: error
        overwrite: true

    - id: clean-up
      run: rm rf ${{ env.path }}