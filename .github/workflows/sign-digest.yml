name: Sign digest
on:
  workflow_call:
    inputs:
      provider:
        default: "LsDevSectigoEV"
        type: string
      job:
        description: The job generated by generate-digest
        required: true
        type: string
    outputs:
      signed-job: 
        value: ${{ jobs.sign-digest.outputs.job }}
env:
  algorithm: ${{ fromJSON(inputs.job).algorithm }}
  artifact: codesign-job-${{ fromJSON(inputs.job).id }}
  path: job-${{ fromJSON(inputs.job).id }}
jobs:
  sign-digest:
    outputs:
      job: ${{ inputs.job }}
    runs-on: [self-hosted, ltops-signing]
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
  
    - id: sign
      working-directory: ${{ env.path }}
      run: |
        readarray -t digests <<<"$(ls *.dig)"
        echo Found ${digests[@]} >&2
        for dig in "${digests[@]}"
        do
          echo Digesting $dig >&2
          digest=$(cat "$dig")
          sign-digest ${{inputs.provider}} ${{ env.algorithm }} "$digest" > "$dig.signed"
        done  
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.artifact }}
        path: ${{ env.path }}
        if-no-files-found: error
        overwrite: true

    - id: clean-up
      run: rm -rf ${{ env.path }}