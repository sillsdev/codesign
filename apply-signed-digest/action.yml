name: SignTool signed digest applicator
description: Attach a signed digest to a file
author: tim-seves
inputs:
  path:
    description: Where to put the signed files.
    default: .
    required: true
  job:
    description: The job generated by generate-digest
    required: true
  description:
    description: The description displayed to the user during UAC prompts. (will be a random temp file name otherwise)
    required: false
runs:
  using: composite
  steps:
  - uses: actions/download-artifact@v4
    env:
      id: ${{ fromJSON(inputs.job).id }}
    with:
      name: codesign-job-${{ env.id }}
      path: job-${{ env.id }}
  - uses: actions/download-artifact@v4
    env:
      id: ${{ fromJSON(inputs.job).id }}
    with:
      name: codesign-digests-${{ env.id }}
      path: job-${{ env.id }}
  - uses: geekyeggo/delete-artifact@v5
    with:
      name: codesign-job-${{ fromJSON(inputs.job).id }}
  - uses: geekyeggo/delete-artifact@v5
    with:
      name: codesign-digests-${{ fromJSON(inputs.job).id }}
  
  - id: apply-signed-digest
    shell: pwsh
    working-directory: job-${{ fromJSON(inputs.job).id }}
    env:
      signtool: C:/"Program Files (x86)"/"Windows Kits"/10/bin/10.0.17763.0/x86/signtool.exe
    run: |
      $Targets = (ConvertFrom-Json -InputObject '${{ inputs.job }}').Targets | Get-Item
      if ("${{ inputs.description }}") {
      ${{env.signtool}} sign /di . /d "${{ inputs.description }}" /v $Targets
      } else {
      ${{env.signtool}} sign /di . /v $Targets
      }
  
  - name: Place signed files
    shell: pwsh
    env:
      id: ${{ fromJSON(inputs.job).id }}
    run: |
      $OutputDir = New-Item -Path ${{ inputs.path }} -ItemType Directory -Force
      Push-Location job-${{ fromJSON(inputs.job).id }}
      (ConvertFrom-Json -InputObject '${{ inputs.job }}').Targets | Move-Item -Destination $OutputDir
      Pop-Location
      Remove-Item job-${{ env.id }} -Recurse
