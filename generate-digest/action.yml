name: SignTool detached digest generator
description: Generate a digest and partially signed artifact for further processing by remotesign workflow and techops/apply-digest action
author: tim-seves
inputs:
  path:
    description: Directory containing files to sign
    required: true
  algorithm:
    description: Digest hash algorithm
    default: "sha256"
    required: true
  url:
    description: Description URL to include in the signed file.
    default: "https://software.sil.org"
  public-cert:
    description: Secret containing the Base64 encoded public cert to sign against.
    required: true
outputs:
    job: 
      description: The job describing the file and parameters to be processed by the sign-digest workflow.
      value: ${{ steps.digest.outputs.job }}
runs:
  using: composite
  steps:
  - name: Generate digest and artifact
    id: digest
    env:
      signtool: C:/"Program Files (x86)"/"Windows Kits"/10/bin/10.0.17763.0/x86/signtool.exe
    shell: pwsh
    working-directory: ${{ inputs.path }}
    run: |
      $PublicCert = [System.Convert]::FromBase64String('${{ inputs.public-cert }}')
      New-Item -Path . -Name digests -ItemType "directory"
      Set-Content .digests/certificate -Value ($PublicCert) -AsByteStream
      Set-Content .digests/algorithm -Value '${{ inputs.algorithm }}'

      ${{env.signtool}} sign /f .certificate /dg .digests /fd ${{ inputs.algorithm }} /du ${{ inputs.url }} /v *
      Write-Output ("job=" + (Get-FileHash . -Algorithm MD5).Hash) >> $ENV:GITHUB_OUTPUT

  - id: upload-working-dir
    uses: actions/upload-artifact@v4
    with:
      name: codesign-job-${{ steps.digest.outputs.job }}
      path: ${{ inputs.path }}
