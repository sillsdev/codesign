name: SignTool signed digest applicator
description: Attach a signed digest to a file
author: tim-seves
inputs:
  path:
    description: Where to put the signed files.
    required: true
  job:
    description: The job generated by generate-digest
    required: true
runs:
  using: composite
  steps:
  - uses: actions/download-artifact@v4
    with:
      name: codesign-job-${{ inputs.job }}
      path: job-${{ inputs.job }}
  - uses: geekyeggo/delete-artifact@v5
    with:
      name: codesign-job-${{ inputs.job }}
  
  - id: apply-signed-digest
    shell: pwsh
    working-directory: job-${{ inputs.job }}
    env:
      signtool: C:/"Program Files (x86)"/"Windows Kits"/10/bin/10.0.17763.0/x86/signtool.exe
    run: |
      ${{env.signtool}} sign /di .digests /v *
  
  - id: clean-up
    shell: pwsh
    run: |
      Copy-Item -Path job-${{ inputs.job }} -Destination ${{ input.path }}
      dir ${{ input.path }}
      dir job-${{ inputs.job }}
      Remove-Item job-${{ inputs.job }} -Recurse
